Gnocis tutorial
==================================

BjÃ¸rn Bredesen, 2018-2019



## Set-up

Here, we will train a PREdictor (Ringrose *et al.* 2003) model on the Kahn *et al.* (2014) Polycomb targets, and predict candidate PREs genome-wide. We will go through all steps that must be executed, from loading a General Feature Format (GFF) file with genomic coordinates for Polycomb targets, extract the underlying sequences, train the model, calibrate the threshold, and predict candidate PREs genome-wide.

This tutorial assumes that Gnocis has been successfully installed.

We will use the *Drosophila melanogaster* genome throughout this tutorial. 
 * **Either**: Download the genome sequence to the folder with the tutorial data: ftp://ftp.flybase.net/genomes/Drosophila_melanogaster/dmel_r5.57_FB2014_03/fasta/dmel-all-chromosome-r5.57.fasta.gz
 * **Or**: In a Linux terminal, navigate to the folder with the tutorial data, and execute the following command: `wget ftp://ftp.flybase.net/genomes/Drosophila_melanogaster/dmel_r5.57_FB2014_03/fasta/dmel-all-chromosome-r5.57.fasta.gz`


## Preparing training data using Gnocis

Download the Gnocis repository, and in a terminal, navigate to the Gnocis `tutorial/` folder. Open the Python3 Read-Eval Print Loop (REPL) by running `python3`.

Run:
```python
# Import the library
import gnocis as cis

# We will use the Drosophila melanogaster genome for multiple examples. We define a stream of is to a variable. The stream ensures that only segments of the genome are loaded at a time, saving memory.
Dmel = cis.streamFASTAGZ('dmel-all-chromosome-r5.57.fasta.gz')

# Load the Kahn et al. (2014) Polycomb targets
Kahn2014Rgn = cis.loadGFF('Kahn2014.GFF')

# Resize and extract from genome
Kahn2014Seq = Kahn2014Rgn\
          .getRandomlyRecentered(3000)\
          .extract(Dmel)

# Split into independent training and test sets
tpos, vpos = Kahn2014Seq.getRandomSplit()
```

This loads the Kahn *et al.* (2014) Polycomb target regions, resizes them to 3kb each, and extracts the underlying sequences from the fruit fly genome. Information about the loaded and processed data can be output by running the following.

Run (optional):
```python
Kahn2014Rgn.printStatistics()
tpos.printStatistics()
```

Output:
```
>>> Kahn2014Rgn.printStatistics()
Region set statistics - GFF file: Kahn2014.GFF
 - Regions: 201
 - Region sequences: 2L, 2R, 3L, 3R, 4, X
 - Mean length: 1000.00 nt (min.: 1000 nt - max.: 1000 nt)
 - Total length: 201000 nt
>>> tpos.printStatistics()
Sequence set statistics - Regions set: GFF file: Kahn2014.GFF (randomly recentered - 3000 bp) - from sequence stream: FASTA sequence stream<dmel-all-chromosome-r5.57.fasta> (split A)
 - Sequences: 100
 - Mean length: 3000.00 nt (min.: 3000 nt - max.: 3000 nt)
 - Total length: 300000 nt
```

We will now generate negative training sequences. To this end, we train a 4th order Markov chain on the PREs, as we did previously (Bredesen *et al.* 2019). Sequences generated by a 4th order Markov chain trained on PREs retains motif-enrichment, but lack the pairing that is characteristic of PREs.

Run:
```python
MCPRE = cis.generatorMarkovChain(trainingSequences = Kahn2014Seq, degree = 4)
tneg = MCPRE.generateSet(n = len(tpos), length = len(tpos[0]))
vneg = MCPRE.generateSet(n = len(vpos)*100, length = len(vpos[0]))
```

This trains the Markov chain a Markov chain on the Kahn *et al.* (2014) set, and randomly generates a set of as many sequences as are in the Kahn *et al.* (2014) set, with the same length as the first sequence.

Run (optional):
```python
tneg.printStatistics()
tneg[0].seq
```

Output (will vary depending on random seed):
```
>>> tneg.printStatistics()
Sequence set statistics - Generated set <Sequences: 100; Length each: 3000; Model: Markov Chain<Degree: 4; Pseudocounts: 1; Add reverse complements: Yes; Training set: Sequence list<Regions set: GFF file: Kahn2014.GFF (randomly recentered - 3000 bp) - from sequence stream: FASTA sequence stream<dmel-all-chromosome-r5.57.fasta>>>; Seed: 182579965>
 - Sequences: 100
 - Mean length: 3000.00 nt (min.: 3000 nt - max.: 3000 nt)
 - Total length: 300000 nt
>>> tneg[0].seq
'GTCCCTCGCTCTTTTTACTTTTTAATTGATGATCGCTTATTAAAACTACGCGTTGCCGTTACGAATTGATGTAACTCAGAGATCGGCGCACAAATAATGCCCCTTGGTGGCGTCGAGCACCATCAACGCGAGCGACATAACCCTTTAACTGCGAAAAAAAGGCAAAAGGCAGCTTGTGAGAGCCACTTGCATAGTGCGGAGCACTGCATTGTATGCGGGGAACTCAATGCTAAAGAATAATTAAGTTCTACCGCATGAATATGCCGGGAATAGATTGTATATCTGGTCCCAAGTTCATAACTGCACATTTGTTGTCGAAATAATGAAGGGATCACCAAACTTAGCTCGGTTATATTACACTCTCTGTTTGGCGAGCGGCCACCGATGTCCCTCCCCAAGCCAGGTTCCTGCAATTTGCCTTCCGCACAGATAACGTTATATACGGACCAAGCCACGCTTACTTTAGTTGTCTAACAGACATGGAAAACAAACTTTTGTGACACTTCCAATTAATTTTGGAGGGAAATTTTCGAGCTCGCTTTGATCTACTACTCTCATTAATGAAGTGAGGACAACAGGCACCTTGATGATACATGTATGCAGCGAAGTTACTTGCCCGGTAATTTGATTAGATTCAGTGAAGTTTGGTGGCTGGAGCAGTAATTTGTTGTTGGCATGTTTATAGGGGCCTCCCAAAATTACTCATGAATGGGTCAGGGCATTGACTAGTTAAATTCTTAGCGACAAAAATCATTCCACGCGCATGTATTGGTTTCCTTACAACTGTGCACTGCGGGAGGTAGCCGCATTTTCACCATTTTACAACAGTGGTTCAGGTCGACGGTTGCTCTCCTGAGTAGATATTTCGCTCCCTCTGGTCCAACTTATCGAACCGAAAAATCGACATTATTAAAACAAAACAGCATAAGAAACACTTTGAGTGGGTAAAATGGGAAATTTTTCGTAAATCAACAACCGCCCCAAAGTTCGGCCAATTCGAGCGAGTCGTAGGCCACATTTGTTCGAAGCACACGCATCGCAGCGGTGTGGCTGCAAAACCATCTCATTCGAAGAACTAACGCTCTTCCTTAATAAGTGTAATAAAATACGCGCAAAAATGGCTGCACTGATTTACTTTTCGAGATTTCAAATGAGCCGTAAACGAGTGGTGGTGCGCCAATTGATGGAGCGAGTGATTAACTGTTATAGCAATAAAAAGCGGCAACCCCTTGTTGACGGTTTTTGTCGGAATCTCCATAGCAGTGGGTGTGGTGCCTGTCGCTGACTTTTTCTGACAAAGACCACAGCATTCGTCTTATGGTGTGCGCAATCCCGCTTGTTCATTTGAAACCGGCTTCTTTTTAATGCCGAAAGGGTAATCATCCAAGCACAATTATTGTTGCGGGGCTAAGTCTCTCTTCTCGTATAAAACAATACGGTGGGGTCATGAGACATATAGTTGTGAGCCCGTGGCTTGTCAGACCTCCCTCTGTGGCTGCGTATCAAATTTCTGTCGGGGGTCGGACAATTCAGAATATCCCGGGAACAGATACGCTGTGGTGGCACGCCTGCCGGCAACCTTCCGGTTATGTGCAGCCGTTTCAGGAGACTTGTAGAAGTGCGCGTTCTATCAGTTTGGGCAACGAACCCAGTGCGATTGGCGGTAAAGCGTTTTTTTCACATTTGTTAATAATATTGTTTATTATTTCTTGTCCAGCTGGATAACTTAAATACACGTCGCAGTTGGCAGTGTTTCCATTATTAGTTTTGCTTTCTGAGAAAGTTATTTTGTGATGCAGAAAGAGCACTTCGTCTGTGCCTGTTCCAAGCTATCTCCCCGAACTACTTAGTGTGTTGCACCGTAATACCGCCCGAGTTGTCCACCGATTTGCGAGATACATGGGAGGAATTAAAACACTTTAATCACAAAAAGTTCTTCAGATTTAAATTAGACACACCGAAAGAAATTCATAAAATGCCGGCCAAATCACCTTCTGTGCAAAAATAATGGTTATTCGAGCGGACTCTTAATATTTCAAGCGAGAGCCGCCAGCAGATGCTCGTCTAAAGCCCCCCCTTGTTCATTTGCGGTTTTGATGGGATTTATAGTCACACTGAATATAATCCAGCGGCGTTGTCCTCTGCCTTCGTCTTTGGTGCACAAGCTTGAAACAGTCAAGAGATAAACTATAAACCCTCGGGTGGCCGTCGCCTCGGGGGCACTGTGGGTGTGTGTGGACAAATGGCACACGCAAATTTCCGATCAACATCTGTCGGAGCATTTAAACTCTTAGCGCGTCCCTTGCAAGGAGGAACCATTTTTCATGAAACATAGCTACATATTATGAGGCACTGTGAGGGTGGGGGAAAGTATGACAGATTAATCTTTACATCAATTTGCAGTGAAAGCAAATATTAAATGGCTCCGCCGAATAAATTCGACGAAAAGTGGAGTTGTTACATGTATCCAGTATAAATGCCGCCCGAGAGATTACAATCTTAATCTATCGTTTTGTTCAAATACAAAAAGTGATCCGTCAAATAAACGGTCGTGTAAAACACAGATTCTCCAAGCTGTCCAGAACCACCGCCATTTATATGAGCGACGAAGCACGAAAACGCCGAGTCGCTAGTTCCCGTTTATCTCAAAGCCCTCTCCATTAAAATTTATTTAAATGCACTTTGAAAAAATTAACCAGATTTTTTGATTCCCAGGGTCAGCAACTCACCTGGAGGGGAAAGCGAGTTCTCCCTCTCCAGCATAATAGGTAATAAAAGATCCAACTAACTGGCGTCGCTTCTTTTTTTGTTTTAAATCCTATATTTTTAAATGCAGATGCTTCGTCAATGCTCAAAAATGCGCTGAATATATGCCCCATTAAATACTTGACCATCGAAAATTGTGCCGCCAGGCGTGCACAGCTGCATATGAAAACCTCCCTCCACTAGAAATGCGGATGGTGTCAGCTGCTTTCGCCATTGGGCGAGTTGTTTTGCTCG'
```


## Training a basic model of *cis*-regulatory module (CRM) sequences

Run:
```python
mdl = cis.trainPREdictorModel(motifs = cis.motifs.getRingrose2003Motifs_GTGT(),
                              positives = tpos,
                              negatives = tneg)
```

This trains a PREdictor model, using the positives and negatives, and the motifs used in Bredesen *et al.* (2019). To manually specify motifs, the following syntax is used:

Run:
```python
mdlC = cis.trainPREdictorModel(motifs = cis.motifs('Custom motif set', [
                                  cis.IUPACMotif('GAF', 'GAGAG', 0),
                                  cis.IUPACMotif('Z', 'YGAGYG', 0),
                                  cis.IUPACMotif('Grh', 'TGTTTTTT', 0),
                                  cis.IUPACMotif('Dsp1', 'GAAAA', 0),
                               ]),
                               positives = tpos,
                               negatives = tneg)
```

The model weights can be inspected.

Run (optional):
```python
mdl.weights
mdlC.weights
```

Output (will vary depending on random seed):
```
>>> mdl.weights
{Feature<PREdictor motif pair occurrence frequency: En, En (within 219 nt)>: 1.252762968495368, Feature<PREdictor motif pair occurrence frequency: En, G10 (within 219 nt)>: 4.356708826689593, Feature<PREdictor motif pair occurrence frequency: En, GAF (within 219 nt)>: 1.1400690023464555, Feature<PREdictor motif pair occurrence frequency: En, PF (within 219 nt)>: 1.0033021088637848, Feature<PREdictor motif pair occurrence frequency: En, PM (within 219 nt)>: 0.6539264674066638, Feature<PREdictor motif pair occurrence frequency: En, PS (within 219 nt)>: 0.8724881092157624, Feature<PREdictor motif pair occurrence frequency: En, Z (within 219 nt)>: 0.7018808605286999, Feature<PREdictor motif pair occurrence frequency: En, GTGT (within 219 nt)>: 0.7276791641023213, Feature<PREdictor motif pair occurrence frequency: G10, G10 (within 219 nt)>: 4.915591745409362, Feature<PREdictor motif pair occurrence frequency: G10, GAF (within 219 nt)>: 3.029137518883944, Feature<PREdictor motif pair occurrence frequency: G10, PF (within 219 nt)>: 1.7466390339475861, Feature<PREdictor motif pair occurrence frequency: G10, PM (within 219 nt)>: 1.4628344382422251, Feature<PREdictor motif pair occurrence frequency: G10, PS (within 219 nt)>: 1.4621703960985815, Feature<PREdictor motif pair occurrence frequency: G10, Z (within 219 nt)>: 2.204367464848599, Feature<PREdictor motif pair occurrence frequency: G10, GTGT (within 219 nt)>: 2.0703148064157855, Feature<PREdictor motif pair occurrence frequency: GAF, GAF (within 219 nt)>: 1.348646995241774, Feature<PREdictor motif pair occurrence frequency: GAF, PF (within 219 nt)>: 0.5968599611077945, Feature<PREdictor motif pair occurrence frequency: GAF, PM (within 219 nt)>: 0.33332757994174145, Feature<PREdictor motif pair occurrence frequency: GAF, PS (within 219 nt)>: 0.2607262624632529, Feature<PREdictor motif pair occurrence frequency: GAF, Z (within 219 nt)>: 0.8400330761916575, Feature<PREdictor motif pair occurrence frequency: GAF, GTGT (within 219 nt)>: 0.5943726095348998, Feature<PREdictor motif pair occurrence frequency: PF, PF (within 219 nt)>: 0.2363887780642302, Feature<PREdictor motif pair occurrence frequency: PF, PM (within 219 nt)>: 0.3600027340314069, Feature<PREdictor motif pair occurrence frequency: PF, PS (within 219 nt)>: 0.10870420160088923, Feature<PREdictor motif pair occurrence frequency: PF, Z (within 219 nt)>: 0.24686007793152598, Feature<PREdictor motif pair occurrence frequency: PF, GTGT (within 219 nt)>: 0.17918042789309396, Feature<PREdictor motif pair occurrence frequency: PM, PM (within 219 nt)>: 1.0116009116784799, Feature<PREdictor motif pair occurrence frequency: PM, PS (within 219 nt)>: 0.2856639082955432, Feature<PREdictor motif pair occurrence frequency: PM, Z (within 219 nt)>: 0.31462670769523315, Feature<PREdictor motif pair occurrence frequency: PM, GTGT (within 219 nt)>: 0.2975497193848584, Feature<PREdictor motif pair occurrence frequency: PS, PS (within 219 nt)>: 0.09899512179075032, Feature<PREdictor motif pair occurrence frequency: PS, Z (within 219 nt)>: 0.10957358237712889, Feature<PREdictor motif pair occurrence frequency: PS, GTGT (within 219 nt)>: 0.0707518054712688, Feature<PREdictor motif pair occurrence frequency: Z, Z (within 219 nt)>: 0.6523788787562861, Feature<PREdictor motif pair occurrence frequency: Z, GTGT (within 219 nt)>: 0.3766683836192142, Feature<PREdictor motif pair occurrence frequency: GTGT, GTGT (within 219 nt)>: 0.6200698922307692}
>>> mdlC.weights
{Feature<PREdictor motif pair occurrence frequency: GAF, GAF (within 219 nt)>: 1.348646995241774, Feature<PREdictor motif pair occurrence frequency: GAF, Z (within 219 nt)>: 0.8400330761916575, Feature<PREdictor motif pair occurrence frequency: GAF, Grh (within 219 nt)>: -0.14660347419187536, Feature<PREdictor motif pair occurrence frequency: GAF, Dsp1 (within 219 nt)>: 0.13968471335245347, Feature<PREdictor motif pair occurrence frequency: Z, Z (within 219 nt)>: 0.6523788787562861, Feature<PREdictor motif pair occurrence frequency: Z, Grh (within 219 nt)>: -0.7401041636477159, Feature<PREdictor motif pair occurrence frequency: Z, Dsp1 (within 219 nt)>: -0.01169009500780227, Feature<PREdictor motif pair occurrence frequency: Grh, Grh (within 219 nt)>: 0.5108256237659905, Feature<PREdictor motif pair occurrence frequency: Grh, Dsp1 (within 219 nt)>: -0.2997062654185827, Feature<PREdictor motif pair occurrence frequency: Dsp1, Dsp1 (within 219 nt)>: 0.2312864087094857}
```


## Predicting genome-wide

In order to make genome-wide predictions, we need to calibrate the threshold of our model. After calibrating, we can apply our model for genome-wide prediction.

```python
# Calibrate threshold
mdl.calibrateGenomewidePrecision(positives = vpos,
                                    genome = Dmel,
                                    factor = 0.5,
                                    precision = 0.8,
                                    bgModelOrder = 4)

# Predict candidate PREs genome-wide
predictions = mdl.predict(Dmel)

# Save predictions to GFF-file
predictions.saveGFF('predictions.GFF')
```

Calibration can take some time. However, on multi-core systems, parallel processing can be enabled by by following command.

Run (optional):
```python
cis.setNCores(4)
```

Run (optional):
```python
mdl.threshold
predictions.printStatistics()
```

The entire training, calibration and prediction procedure can be written more compactly, as

```python
cis.trainPREdictorModel(motifs = cis.motifs.getRingrose2003Motifs_GTGT(),
                              positives = tpos,
                              negatives = tneg)\
         .calibrateGenomewidePrecision(positives = Kahn2014Seq,
                              genome = 'dmel-all-chromosome-r5.57.fasta',
                              factor = 0.5,
                              precision = 0.8,
                              bgModelOrder = 4)\
         .predict('dmel-all-chromosome-r5.57.fasta')\
         .saveGFF('predictions.GFF')
```


## Preparing a training set based on genome-wide experimental data

When we trained models in the last sections, we used published sets of Polycomb targets. In this section, we will define Polycomb targets based on data from modENCODE, in order to train our model.
We have downloaded genome-wide peaks for three *D. melanogaster* Polycomb group proteins and one histone modification:
 * Pc - Source: ftp://data.modencode.org/D.melanogaster/Non-TF-Chromatin-binding-factor/ChIP-seq/computed-peaks_gff3/Pc%3ADevelopmental-Stage=Embryos-14-16-hr-OR%23Strain=Oregon-R%3AChIP-seq%3ARep-1%3A%3ADmel_r5.32%3AmodENCODE_3957%3A816.gff3.gz
 * Psc - Source: source URL: ftp://data.modencode.org/D.melanogaster/Non-TF-Chromatin-binding-factor/ChIP-seq/computed-peaks_gff3/Psc%3ADevelopmental-Stage=Embryos-14-16-hr-OR%23Strain=Oregon-R%3AChIP-seq%3ARep-1%3A%3ADmel_r5.32%3AmodENCODE_3960%3A1817.gff3.gz
 * dRING - Source: ftp://data.modencode.org/D.melanogaster/Non-TF-Chromatin-binding-factor/ChIP-seq/computed-peaks_gff3/dRING%3ADevelopmental-Stage=Embryos-14-16-hr-OR%23Strain=Oregon-R%3AChIP-seq%3ARep-1%3A%3ADmel_r5.32%3AmodENCODE_5071%3A1819.gff3.gz
 * H3K27me3 - Source URL: tp://data.modencode.org/D.melanogaster/Histone-Modification/ChIP-seq/computed-peaks_gff3/H3K27me3%3ADevelopmental-Stage=Embryos-14-16-hr-OR%23Strain=Oregon-R%3AChIP-seq%3ARep-1%3A%3ADmel_r5.32%3AmodENCODE_3955%3A1820.gff3.gz

These are included with the tutorial, considered as fair use for example material. All credit for these sets belongs to Karpen G. *et al.* and modENCODE.

We will now prepare candidate Polycomb targets based on these sets, using the `biomarkers` class in gnocis.

Run:
```python
# Define the biomarker set, loading signals for each biomarker
PcG = cis.biomarkers(name = 'PcG', regionSets = [
	cis.loadGFFGZ('Pc.gff3.gz').getRenamed('Pc'),
	cis.loadGFFGZ('Psc.gff3.gz').getRenamed('Psc'),
	cis.loadGFFGZ('dRING.gff3.gz').getRenamed('dRING'),
	cis.loadGFFGZ('H3K27me3.gff3.gz').getRenamed('H3K27me3')
])

# Define Highly BioMarker-Enriched loci (HBMEs) based on biomarkers
PcGTargets = PcG.getHBMEs( Dmel.getWindowRegions(size = 1000, step = 500), threshold = 2 )
```

Run (optional):
```python
PcG
PcGTargets
```

Output:
```
>>> PcG
Biomarker set<PcG (H3K27me3 (1486 regions - 1 sets); Pc (1405 regions - 1 sets); Psc (2628 regions - 1 sets); dRING (3473 regions - 1 sets))>
>>> PcGTargets.printStatistics()
Region set statistics - Windows (Window size: 1000 bp; step size: 500 bp) (PcG HBME)
 - Regions: 1534
 - Region sequences: 2L, 2R, 3L, 3LHet, 3R, 4, U, X
 - Mean length: 7967.41 nt (min.: 1000 nt - max.: 227500 nt)
 - Total length: 12222000 nt
```

-------------------------------------------------

## References

 * Bredesen *et al.* 2019: https://academic.oup.com/nar/article/47/15/7781/5538007
 * Kahn *et al.* 2014: https://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1004495
 * FlyBase - : https://academic.oup.com/nar/article/41/D1/D751/1051942
 * Ringrose *et al.* 2003: https://www.sciencedirect.com/science/article/pii/S153458070300337X
 * ModENCODE: 

